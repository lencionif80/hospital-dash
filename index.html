<!-- filename: index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
  />
  <title>Il Divo: Hospital Dash!</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 32 32%27><rect width=%2732%27 height=%2732%27 fill=%27%230d1117%27/><text x=%2750%25%27 y=%2756%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27Arial%27 font-size=%2720%27 fill=%27%23fff%27>HD</text></svg>">


  <!-- Fuente arcade (con fallback local del sistema) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <script>
    // Registro global de clases/ayudas de entidades
    window.Entities = {};
  </script>
</head>
<body class="intro-playing">
  <div id="loading-screen" aria-live="polite" role="status">
    <div id="loading-text">Cargando...</div>
    <div id="loading-bar-container" aria-label="Progreso de carga">
      <div id="loading-bar"></div>
    </div>
  </div>

  <div id="game-container" aria-label="Contenedor del juego">
    <!-- Lienzo principal que dibuja TODO el juego -->
    <canvas id="gameCanvas" width="960" height="540" aria-label="Lienzo del juego"></canvas>
    <canvas id="fogCanvas"></canvas>
    <canvas id="hudCanvas"></canvas>
    <button id="btn-fullscreen" type="button" class="floating-btn" aria-label="Activar pantalla completa">
      Pantalla completa
    </button>

    <!-- START -->
    <div id="start-screen" class="overlay hidden">
      <div class="menu-box">
        <h1>Il Divo: Hospital Dash!</h1>
        <p class="subtitle">WASD para moverte ¬∑ E para empujar/usar ¬∑ ESC pausa ¬∑ R reinicia</p>

        <h2 class="section-title">Elige tu personaje</h2>

        <!-- Grid de personajes -->
        <div class="start-screen-frame" aria-hidden="true"></div>

        <div class="char-grid" role="listbox" aria-label="Selecci√≥n de personaje">
          <button class="char-card selected" role="option" aria-selected="true" data-hero="enrique" tabindex="0">
            <div class="char-avatar hero-avatar char-enrique" aria-hidden="true"></div>
            <div class="char-info">
              <strong>Enrique</strong>
              <span>Equilibrado (visi√≥n x1.0)</span>
              <span>Velocidad 3.9 ¬∑ Empuje 6.0</span>
            </div>
          </button>

          <button class="char-card" role="option" aria-selected="false" data-hero="roberto" tabindex="0">
            <div class="char-avatar hero-avatar char-roberto" aria-hidden="true"></div>
            <div class="char-info">
              <strong>Roberto</strong>
              <span>R√°pido (visi√≥n x1.0)</span>
              <span>Velocidad 4.6 ¬∑ Empuje 4.8</span>
            </div>
          </button>

          <button class="char-card" role="option" aria-selected="false" data-hero="francesco" tabindex="0">
            <div class="char-avatar hero-avatar char-francesco" aria-hidden="true"></div>
            <div class="char-info">
              <strong>Francesco</strong>
              <span>Explorador (visi√≥n x1.25)</span>
              <span>Velocidad 4.1 ¬∑ Empuje 5.0</span>
            </div>
          </button>
        </div>

        <div class="options">
          <label><input type="checkbox" id="opt-reduce-flash" checked /> Reducir destellos</label>
          <label><input type="checkbox" id="opt-humor" /> Modo ‚ÄúHumor Suave‚Äù</label>
          <button id="btn-3dacc" type="button">activa aceleraci√≥n gr√°fica 3d</button>
        </div>

        <button id="start-button" class="primary">Empezar turno</button>
        <p class="tip">Objetivo: atiende todos los <b>P</b> para abrir <b>D</b>, y acerca el <b>carro C</b> al jefe <b>X</b> (‚â§ 2 casillas).</p>
      </div>
    </div>

    <!-- PAUSA -->
    <div id="pause-screen" class="overlay hidden" aria-live="polite">
      <div class="menu-box">
        <h2>PAUSA</h2>
        <p>Pulsa <b>ESC</b> para continuar</p>
      </div>
    </div>

    <!-- NIVEL COMPLETADO -->
    <div id="level-complete-screen" class="overlay hidden" aria-live="polite">
      <div class="menu-box">
        <h2>¬°NIVEL COMPLETADO!</h2>
        <p>¬°Has salvado el turno! üéâ</p>
        <p>Pulsa <b>R</b> para jugar de nuevo.</p>
      </div>
    </div>

    <!-- GAME OVER -->
    <div id="game-over-screen" class="overlay hidden" aria-live="polite">
      <div class="menu-box">
        <h2>GAME OVER</h2>
        <p>El caos te ha superado üòµ‚Äçüí´</p>
        <p>Pulsa <b>R</b> para intentarlo de nuevo.</p>
      </div>
    </div>
  </div>

  <!-- JS (no modules para funcionar con file://) -->
  <!-- Utilidades base -->
  <script src="./assets/config/ascii_legend.js"></script>
  <script src="./assets/plugins/logs.plugin.js"></script>
  <script src="./assets/plugins/utils/xml.config.js"></script>
  <script src="./assets/plugins/patients.names.js"></script>
  <script src="./assets/plugins/entity.groups.plugin.js"></script>

  <!-- Sistemas principales -->
  <script src="./assets/plugins/physics.plugin.js"></script>
  <script src="./assets/plugins/lighting.plugin.js"></script>
  <script src="./assets/plugins/skyweather.plugin.js"></script>
  <script src="./assets/plugins/arrowguide.plugin.js"></script>
  <script src="./assets/plugins/damage.plugin.js"></script>
  <script src="./assets/plugins/puppet.plugin.js"></script>
  <script src="./assets/plugins/cinefx.plugin.js"></script>
  <script src="./assets/plugins/audio.plugin.js"></script>
  <script src="./assets/plugins/music.manager.plugin.js"></script>
  <script src="./assets/plugins/music.plugin.js"></script>
  <script src="./assets/plugins/placement.plugin.js"></script>
  <script src="./assets/plugins/mapgen.plugin.js"></script>
  <script src="./assets/plugins/presentation.plugin.js"></script>
  <script src="./assets/plugins/mouse.control.plugin.js"></script>
  <script src="./assets/plugins/dialog.plugin.js"></script>
  <script src="./assets/plugins/objectiveflow.plugin.js"></script>
  <script src="./assets/plugins/hud.plugin.js"></script>
  <script src="./assets/plugins/score.plugin.js"></script>
  <script src="./assets/plugins/bells.plugin.js"></script>
  <script src="./assets/plugins/narrator.plugin.js"></script>
  <script src="./assets/plugins/gameflow.plugin.js"></script>

  <!-- Layout m√≥vil: bloqueo portrait + escalado start-screen -->
  <script src="./assets/plugins/mobile_layout.js"></script>

  <!-- AI -->
  <script src="./assets/plugins/ai/ai.registry.plugin.js"></script>
  <script src="./assets/plugins/ai/builtin.ai.plugin.js"></script>
  <script src="./assets/plugins/ai/furious.plugin.js"></script>
  <script src="./assets/plugins/ai/human_ai.plugin.js"></script>

  <!-- Entidades -->
  <script src="./assets/plugins/entities/entities.base.js"></script>
  <script src="./assets/plugins/entities/bossrush.entities.js"></script>
  <script src="./assets/plugins/entities/carts.entities.js"></script>
  <script src="./assets/plugins/entities/celador.entities.js"></script>
  <script src="./assets/plugins/entities/cleaner.entities.js"></script>
  <script src="./assets/plugins/entities/doors.entities.js"></script>
  <script src="./assets/plugins/entities/elevators.entities.js"></script>
  <script src="./assets/plugins/entities/enfermera_sexy.entities.js"></script>
  <script src="./assets/plugins/entities/familiar_molesto.entities.js"></script>
  <script src="./assets/plugins/entities/fire.entities.js"></script>
  <script src="./assets/plugins/entities/guardia.entities.js"></script>
  <script src="./assets/plugins/entities/hazards.entities.js"></script>
  <script src="./assets/plugins/entities/heroes.entities.js"></script>
  <script src="./assets/plugins/entities/jefe_servicio.entities.js"></script>
  <script src="./assets/plugins/entities/lights.entities.js"></script>
  <script src="./assets/plugins/entities/medico.entities.js"></script>
  <script src="./assets/plugins/entities/mosquito.entities.js"></script>
  <script src="./assets/plugins/entities/objects.entities.js"></script>
  <script src="./assets/plugins/entities/patient_furiosa.entities.js"></script>
  <script src="./assets/plugins/entities/patients.entities.js"></script>
  <script src="./assets/plugins/entities/phone.entities.js"></script>
  <script src="./assets/plugins/entities/rat.entities.js"></script>
  <script src="./assets/plugins/entities/spawner.entities.js"></script>
  <script src="./assets/plugins/entities/supervisor.entities.js"></script>
  <script src="./assets/plugins/entities/tcae.entities.js"></script>

  <!-- ‚¨áÔ∏è NUEVO: sprites unificado, SIEMPRE ANTES de game.js -->
  <script src="./assets/plugins/sprites.plugin.js"></script>

  <script id="sprites-manifest" type="application/json">
  [
    "ascensor_abierto.png","ascensor_cerrado.png",
    "boss_nivel1.png","boss_nivel2.png","boss_nivel3.png",
    "carro_comida.png","carro_medicinas.png","carro_urgencias.png",
    "celador.png","chica_limpieza.png","enfermera_sexy.png","medico.png",
    "supervisora.png","TCAE.png","jefe_servicio.png","familiar_molesto.png",
    "enrique.png","roberto.png","francesco.png",
    "mosquito.png","raton.png",
    "paciente1.png","paciente2.png","paciente3.png","paciente4.png",
    "paciente5.png","paciente6.png","paciente7.png","paciente_furiosa.png",
    "gotero_azul.png","gotero_verde.png","gotero_rojo.png",
    "jeringa_azul.png","jeringa_verde.png","jeringa_roja.png",
    "pastilla_analitica.png","pastilla_azul.png","pastilla_gaviscon.png",
    "pastilla_luzon.png","pastilla_patoplast.png","pastilla_tillaout.png",
    "pastilla_zenidina.png",
    "comida_brascada.png","comida_calamares.png","comida_cerveza.png",
    "comida_copa_de_vino.png","comida_cremaet.png","comida_figatell.png",
    "comida_sepia_a_la_plancha.png",
    "prohibido.png","mano.png","engranaje.png","cronometro.png","fuego.png",
    "x.png","timbre_apagado.png","timbre_encendido.png","telefono.png",
    "guardia.png","spawner_enemigos.png","spawner_npc.png","spawner_carros.png",
    "pared.png","suelo.png","charco.png",
    "puerta_abiertas.png","puerta_cerrada.png",
    "logo_grupo.png","logo_juego.png",
    "main.jpg","ready.jpg","gameover.jpg",
    "foto_almuerzo.png","foto_almuerzo2.png",
    "foto_enrique&raquel.png","foto_grupo.png","foto_il_divo_con_carino.png",
    "foto_los3.png","foto_navidad.png"
  ]
  </script>


  <!-- Motor central SIEMPRE el √∫ltimo -->
  <script src="./assets/plugins/game.js"></script>

<script>
(function(){
  // === Bot√≥n de "aceleraci√≥n 3D" (gag) ===
  const gags = [
    "No existe ninguna aceleraci√≥n 3D, es broma üòú",
    "En serio: esto es 2D con mucho cari√±o.",
    "¬øOtra vez? No funciona. Deja de clicar.",
    "Inicializando RTX... 0%... ERROR 418 (I‚Äôm a teapot).",
    "Drivers no encontrados: humor.dll",
    "Has desbloqueado: Bot√≥n In√∫til Nivel 2.",
    "Tip: Empuja el carro, no el bot√≥n.",
    "Calculando pol√≠gonos... 0/‚àû",
    "RTX OFF. Caf√© ON.",
    "√öltima: de verdad que no va üòâ"
  ];
  let i = 0;
  const btn = document.getElementById('btn-3dacc');
  if (btn){
    btn.addEventListener('click', () => {
      const p = document.createElement('div');
      p.className = 'sys-pop';
      p.innerHTML = gags[i++ % gags.length] + ' <button class="close">Ok</button>';
      document.body.appendChild(p);
      const kill = () => p.remove();
      p.querySelector('.close').addEventListener('click', kill);
      setTimeout(kill, 3500);
    });
  }
})();
</script>

<script>
  const ensureMenuMusic = (() => {
    let started = false;
    return (opts = {}) => {
      const mapParam = new URLSearchParams(location.search || '').get('map');
      const isDebugMap = (mapParam || '').toLowerCase() === 'debug' || (window.__MAP_MODE || '').toLowerCase() === 'debug';
      if (isDebugMap) return;
      if (started) return;
      started = true;
      try {
        window.MusicManager?.playMenu?.(Object.assign({ loop: true, fadeTime: 0.35 }, opts));
      } catch (_) {}
    };
  })();

  window.addEventListener('load', () => {
    // ---- flujo normal (sin ?mini=1 ni ?map=mini|debug) ----
    try { window.MusicManager?.init?.(); } catch (_) {}
    if (window.PresentationAPI && PresentationAPI.playIntroSequence) {
      PresentationAPI.playIntroSequence();
    } else {
      ensureMenuMusic();
    }
  });
 
// Cuando la intro termina, aparece el start-screen y NOS ASEGURAMOS
// de que nada quede por encima bloqueando clics.
window.addEventListener('intro:complete', () => {
  const ss = document.getElementById('start-screen');
  if (ss){
    ss.classList.remove('hidden','intro-disable-ui','intro-hide-ui');
    ss.style.animation = 'pa2FadeIn .45s ease';
    ss.style.pointerEvents = 'auto';
    ss.style.opacity = '1';
    document.querySelectorAll('#start-screen button').forEach(b => b.removeAttribute('disabled'));

    // Al empezar el juego, elimina logo+halo (viven dentro del start-screen)
    const killBrand = () => document.getElementById('brandWrap')?.remove();
    document.getElementById('start-button')?.addEventListener('click', killBrand, { once:true });
    window.addEventListener('game:start', killBrand, { once:true });
  }
  ensureMenuMusic({ fadeTime: 0.45 });
  document.body.classList.remove('intro-playing');
});
</script>
<script src="assets/plugins/mobile.js"></script>
</body>
</html>
